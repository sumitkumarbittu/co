<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loading...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #333;
            font-family: monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #c {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #h {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            background: transparent;
            border: none;
            outline: none;
            cursor: default;
            z-index: 10;
        }

        .l-text {
            font-size: 12px;
            color: #222;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.3;
            }
        }
    </style>
</head>

<body>

    <div id="c">
        <div class="l-text">Computing...</div>
    </div>
    <input id="h" autocomplete="off" autofocus>
    <input type="file" id="g-file" hidden>

    <script>
        const RENDER_BACKEND_URL = 'https://co2026.onrender.com';
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = (isLocal || window.location.origin.includes('github.io')) && !isLocal ? RENDER_BACKEND_URL : '';

        let t;
        let l = true;
        let a = false;
        let p = null;
        let d = null;

        const c = document.getElementById('c');
        const h = document.getElementById('h');

        function lock() {
            l = true;
            c.innerHTML = '<div class="l-text">Computing...</div><div id="lock-f" style="font-size:10px; color:#444; margin-top:10px; display:none;"></div>';
            c.style.display = 'flex';
            c.style.flexDirection = 'column';
            stopPoll();
            h.value = '';
            h.style.display = 'block';
            h.focus();
            renderPreview();
        }

        function unlock(ui) {
            l = false;
            c.innerHTML = ui;
            c.style.display = 'block';
            h.style.display = 'none';

            initChat();
            startPoll();
            resetTimer();
        }

        function resetTimer() {
            clearTimeout(t);
            if (a && !l) {
                t = setTimeout(lock, 5000);
            }
        }

        ['mousemove', 'keydown', 'click', 'touchstart'].forEach(e => {
            document.addEventListener(e, () => {
                if (!l) resetTimer();
            });
        });

        h.addEventListener('input', (e) => {
            const v = e.target.value;
            clearTimeout(d);
            d = setTimeout(() => tryAuth(v), 800);
        });

        document.addEventListener('click', () => {
            if (l) h.focus();
        });

        async function tryAuth(pw) {
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/login` : '/api/login';
                const r = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pw }),
                    credentials: 'include'
                });

                if (r.ok) {
                    const data = await r.json();
                    if (data.success && data.ui) {
                        a = true;
                        h.value = '';
                        unlock(data.ui);
                    }
                }
            } catch (ignore) { }
        }

        let msgDiv = null;
        let inInput = null;
        let selectedFile = null;

        const gf = document.getElementById('g-file');
        if (gf) {
            gf.addEventListener('change', (e) => {
                if (e.target.files[0]) setFile(e.target.files[0]);
            });
        }

        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                setFile(e.dataTransfer.files[0]);
            }
        });

        function setFile(f) {
            selectedFile = f;
            renderPreview();
        }

        function clearFile() {
            selectedFile = null;
            if (gf) gf.value = '';
            renderPreview();
        }

        function renderPreview() {
            const pa = document.getElementById('preview-area');
            const lf = document.getElementById('lock-f');

            if (selectedFile) {
                if (pa) {
                    pa.innerHTML = `
                        <div class="att-badge">
                            <span>${esc(selectedFile.name)}</span>
                            <button type="button" class="att-rem" onclick="clearFile()">Ã—</button>
                        </div>
                    `;
                    pa.style.display = 'block';
                }
                if (lf) {
                    lf.innerText = `[ ${selectedFile.name} ]`;
                    lf.style.display = 'block';
                }
            } else {
                if (pa) {
                    pa.innerHTML = '';
                    pa.style.display = 'none';
                }
                if (lf) {
                    lf.style.display = 'none';
                }
            }
        }

        function initChat() {
            const f = document.querySelector('#input-form');
            inInput = document.querySelector('.chat-input');
            msgDiv = document.querySelector('#messages');

            if (f && inInput) {
                f.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!inInput.value && !selectedFile) return;

                    const content = inInput.value;
                    inInput.value = '';
                    const fileToSend = selectedFile;
                    clearFile();

                    await send(content, fileToSend);
                    fetchMsgs();
                    resetTimer();
                });
                inInput.focus();

                if (selectedFile) renderPreview();
            }
        }

        async function fetchMsgs() {
            if (l) return;
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/messages` : '/api/messages';
                const r = await fetch(url, { credentials: 'include' });
                if (r.status === 401) { lock(); a = false; return; }
                const d = await r.json();
                render(d);
            } catch (e) { }
        }

        function render(msgs) {
            if (!msgDiv) return;
            msgDiv.innerHTML = msgs.map(m => {
                let mediaHtml = '';
                if (m.media_id) {
                    const mediaUrl = API_BASE_URL ? `${API_BASE_URL}/api/media/${m.media_id}` : `/api/media/${m.media_id}`;
                    const type = (m.mime_type && m.mime_type.startsWith('image/')) ? 'img' : 'file';
                    mediaHtml = `
                        <div class="media-preview" onclick="showMedia('${mediaUrl}', '${type}')">
                            <div class="media-icon" style="height: 60px; flex-direction: column; gap: 4px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                                <span style="font-size: 10px; opacity: 0.8; letter-spacing: 0.5px;">VIEW ATTACHMENT</span>
                            </div>
                        </div>`;
                }
                return `
                <div class="msg-row">
                    <div class="msg-bubble">
                        ${m.content ? `<div>${esc(m.content)}</div>` : ''}
                        ${mediaHtml}
                        <div class="msg-time">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                </div>
            `}).join('');
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        function showMedia(url, type) {
            const modal = document.getElementById('preview-modal');
            const container = document.getElementById('media-container');
            const downloadBtn = document.getElementById('download-btn');
            if (!modal || !container || !downloadBtn) return;

            container.innerHTML = type === 'img'
                ? `<img src="${url}" class="modal-content">`
                : `<div style="color:white; font-size:18px;">File Preview Not Available</div>`;

            downloadBtn.href = url;
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('preview-modal');
            if (modal) modal.style.display = 'none';
        }

        async function send(c, file) {
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/messages` : '/api/messages';

                let body;
                let headers = {};

                if (file) {
                    const fd = new FormData();
                    fd.append('content', c);
                    fd.append('file', file);
                    body = fd;
                } else {
                    body = JSON.stringify({ content: c });
                    headers['Content-Type'] = 'application/json';
                }

                await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: body,
                    credentials: 'include'
                });
            } catch (e) { }
        }

        function startPoll() {
            if (p) clearInterval(p);
            fetchMsgs();
            p = setInterval(fetchMsgs, 2000);
        }

        function stopPoll() {
            if (p) clearInterval(p);
            p = null;
        }

        function esc(t) {
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Init
        h.focus();
    </script>
</body>

</html>