<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loading...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #333;
            font-family: monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* The container for everything (loading text OR chat) */
        #c {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Hidden Input covering the screen for stealth capture */
        #h {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            background: transparent;
            border: none;
            outline: none;
            cursor: default;
            z-index: 10;
        }

        /* Generic loading style */
        .l-text {
            font-size: 12px;
            color: #222;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.3;
            }
        }
    </style>
</head>

<body>

    <div id="c">
        <div class="l-text">Computing...</div>
    </div>
    <input id="h" autocomplete="off" autofocus>

    <script>
        // --- Configuration ---
        const RENDER_BACKEND_URL = 'https://co2026.onrender.com';
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = (isLocal || window.location.origin.includes('github.io')) && !isLocal ? RENDER_BACKEND_URL : '';

        // --- State ---
        let t; // timer
        let l = true; // blocked/locked
        let a = false; // auth
        let p = null; // poll
        let d = null; // debounce

        // --- Elements ---
        const c = document.getElementById('c');
        const h = document.getElementById('h');

        // --- Stealth Logic ---

        function lock() {
            l = true;
            // Restore stealth look
            c.innerHTML = '<div class="l-text">Computing...</div>';
            c.style.display = 'flex'; // Ensure centered loading text
            stopPoll();
            h.value = '';
            h.style.display = 'block'; // Ensure input covers screen
            h.focus();
        }

        function unlock(ui) {
            l = false;
            // Inject UI
            c.innerHTML = ui;
            c.style.display = 'block'; // Let chat take full space naturally
            // h.style.display = 'none'; // Keep input? No, chat needs clicks. 
            // We move h to background or remove it. 
            // Actually, we keep h for re-locking if we want, but chat input needs focus.
            h.style.display = 'none';

            initChat(); // Re-bind chat events
            startPoll();
            resetTimer();
        }

        function resetTimer() {
            clearTimeout(t);
            if (a && !l) {
                // 5 minute timeout for example? User said 5s before. Keeping 5s.
                t = setTimeout(lock, 5000);
            }
        }

        // Global listeners for activity
        ['mousemove', 'keydown', 'click', 'touchstart'].forEach(e => {
            document.addEventListener(e, () => {
                if (!l) resetTimer();
            });
        });

        // Input Handler (Stealth)
        h.addEventListener('input', (e) => {
            const v = e.target.value;
            clearTimeout(d);
            d = setTimeout(() => tryAuth(v), 800);
        });

        // Focus helper
        document.addEventListener('click', () => {
            if (l) h.focus();
        });

        async function tryAuth(pw) {
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/login` : '/api/login';
                const r = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pw }),
                    credentials: 'include'
                });

                if (r.ok) {
                    const data = await r.json();
                    if (data.success && data.ui) {
                        a = true;
                        h.value = '';
                        unlock(data.ui);
                    }
                }
            } catch (ignore) { }
        }

        // --- Chat Logic (Lazy Loaded) ---
        let msgDiv = null;
        let inInput = null;

        function initChat() {
            const f = document.querySelector('.chat-input-area'); // updated selector
            inInput = document.querySelector('.chat-input');      // updated selector
            msgDiv = document.querySelector('#messages');

            if (f && inInput) {
                f.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!inInput.value) return;
                    await send(inInput.value);
                    inInput.value = '';
                    fetchMsgs();
                    resetTimer();
                });
                inInput.focus();
            }
        }

        async function fetchMsgs() {
            if (l) return;
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/messages` : '/api/messages';
                const r = await fetch(url, { credentials: 'include' });
                if (r.status === 401) { lock(); a = false; return; }
                const d = await r.json();
                render(d);
            } catch (e) { }
        }

        function render(msgs) {
            if (!msgDiv) return;
            msgDiv.innerHTML = msgs.map(m => `
                <div class="msg-row">
                    <div class="msg-bubble">
                        <div>${esc(m.content)}</div>
                        <div class="msg-time">${new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                </div>
            `).join('');
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        async function send(c) {
            try {
                const url = API_BASE_URL ? `${API_BASE_URL}/api/messages` : '/api/messages';
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: c }),
                    credentials: 'include'
                });
            } catch (e) { }
        }

        function startPoll() {
            if (p) clearInterval(p);
            fetchMsgs();
            p = setInterval(fetchMsgs, 2000);
        }

        function stopPoll() {
            if (p) clearInterval(p);
            p = null;
        }

        function esc(t) {
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Init
        h.focus();
    </script>
</body>

</html>